{% extends "layout.html" %}
{% block content %}
<div class="container-fluid">
  <div class="row"><br/></div> <!-- Spacer row -->
  <div class="row">
    <div class="col">

      <h3>Scanned Documents</h3>

      <table id="documentsTable" class="table table-hover" cellspacing="0">
        <thead>
          <tr>
            <th scope="col">Name</th>
            <th scope="col">Size</th>
            <th scope="col">Date</th>
            <th scope="col">View</th>
          </tr>
        </thead>
        <tbody>
          {% for pdf in liste %}
          <tr>
            <td>{{ pdf.name }}</td>
            <td>{{ pdf.size }}</td>
            <td>{{ pdf.date }}</td>
            <td>
              <span class="table-view">
                <button type="button" id="{{ pdf.name }}" class="btn btn-primary btn-rounded btn-sm px-3" data-toggle="tooltip" data-placement="bottom" title="Document preview">
                  <i class="fas fa-eye"></i>
                </button>
              </span>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

    </div>

    <div class="col" id="pdfPreviewSection">

      <form action="/" name="editForm" onsubmit="return validateFileName()" method="POST">
        <h3>Edit and Move</h3>
        <div class="row mb-2">
          <div class="col-2">
            <!-- Folder select button triggers modal -->
            <button type="button" class="btn btn-primary btn-sm" id="btnselectfolder" data-toggle="modal" data-target="#folderModal" data-placement="right" title="Select target folder">
              <i class="fas fa-folder"></i>
            </button>
          </div>
          <div class="col-10">
            <p id="folderDisplay">{{ selected_folder }}</p>
            <input type="hidden" id="selectedFolder" name="folder" value="{{ selected_folder }}">
          </div>
        </div>
        <div class="row mb-3">
          <div class="col-10">
            <!-- Editable document title -->
            <input type="text" id="editTitle" class="form-control" name="pdf" value="">
            <!-- Hidden inputs for state tracking -->
            <input type="hidden" id="currentIndex" name="inputiterator" value="">
            <input type="hidden" id="originalFileName" name="oldpdf" value="">
            <input type="hidden" id="selectedFolder" name="folder" value="unknown">
            <input type="hidden" id="sortColumn" name="sortCol" value="{{ sort_column|default(2) }}">
            <input type="hidden" id="sortDirection" name="sortDir" value="{{ sort_direction|default('desc') }}">
            <input type="hidden" id="searchTerm" name="searchTerm" value="{{ search_term|default('') }}">
          </div>
          <div class="col-2">
            <!-- Submit edit -->
            <button type="submit" class="btn btn-primary btn-sm" data-toggle="tooltip" data-placement="bottom" title="Edit document title">
              <i class="fas fa-check"></i>
            </button>
          </div>
        </div>
      </form>

      <hr>

      <!-- Action buttons -->
      <button type="submit" class="btn btn-primary btn-sm" id="btnNext" data-toggle="tooltip" data-placement="bottom" title="Preview next document">
        <i class="fas fa-angle-double-right"></i>
      </button>
      <button type="submit" class="btn btn-primary btn-sm" id="btnMagic" data-toggle="tooltip" data-placement="bottom" title="OCR-Scan and set keywords for autoscan">
        <i class="fas fa-magic"></i>
      </button>
      <button type="submit" class="btn btn-primary btn-sm" id="btnRotate" data-toggle="tooltip" data-placement="bottom" title="Rotate document 180">
        <i class="fas fa-redo"></i>
      </button>
      <button type="submit" class="btn btn-primary btn-sm" id="btnDownload" data-toggle="tooltip" data-placement="bottom" title="Download document">
        <i class="fas fa-download"></i>
      </button>
      <button type="button" class="btn btn-primary btn-sm" id="btnDelete" data-toggle="modal" data-target="#deleteModal" data-placement="bottom" title="Delete this document">
        <i class="fas fa-trash"></i>
      </button>

      <!-- PDF viewer iframe -->
      <iframe
        id="pdfViewerFrame"
        src="/static/pdfjs/web/viewer.html?file=/static/pdf/unknown/{{ preview }}"
        width="100%"
        height="800px"
        frameborder="0"
        style="border: none;">
      </iframe>

    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel">Delete file?</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        This file will be permanently deleted and cannot be recovered.<br/> Are you sure?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" data-dismiss="modal">Close</button>
        <button type="button" id="btnConfirmDelete" class="btn btn-primary btn-sm">Delete</button>
      </div>
    </div>
  </div>
</div>

<!-- Folder Selection Modal -->
<div class="modal fade" id="folderModal" tabindex="-2" role="dialog" aria-labelledby="folderModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="folderModalLabel">Select folder</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="treeview">
          <ul class="mb-1 pl-3 pb-2">
            <li><i class="fas fa-angle-right rotate"></i>
              <span><i class="far fa-folder-open ic-w mx-1"></i>
                <a href="javascript:void(0)" onclick="selectfolder('unknown');">Unknown</a>
              </span>
              <ul class="nested"></ul>
            </li>
            <li><i class="fas fa-angle-right rotate"></i>
              <span><i class="far fa-folder-open ic-w mx-1"></i>
                <a href="javascript:void(0)" onclick="selectfolder('/Archiv/');">Main archive folder</a>
              </span>
              <ul class="nested"></ul>
            </li>
            <hr>
            {{ subdirhtml|safe }}
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  /**
   * Validate filename on form submit.
   * Disallow empty input and forbidden Windows filename chars and control chars.
   * @returns {boolean} true if valid, else false
   */
  function validateFileName() {
    const fileName = document.forms["editForm"]["pdf"].value.trim();
    if (!fileName) {
      alert("Name must be filled out");
      return false;
    }
    // Forbidden characters: \ / : * ? " < > | and control chars (0x00-0x1F)
    const forbiddenPattern = /^[^\\\/:\*\?"<>\|\x00-\x1F]+$/u;
    if (!forbiddenPattern.test(fileName)) {
      alert('Invalid characters in filename. Avoid \\ / : * ? " < > | and control characters.');
      return false;
    }
    return true;
  }
  
  /**
   * Select folder from modal, update hidden input and UI, then close modal.
   * @param {string} folderName - Selected folder path/name
   */
  function selectfolder(folderName) {
    document.getElementById("selectedFolder").value = folderName;
    document.getElementById("folderDisplay").textContent = folderName;
    $('#folderModal').modal('hide');
    console.log("Selected folder:", folderName);
  }

  /**
   * Periodically check server for new scanned documents.
   * If update detected, reset update flag and reload page.
   */
  function checkUpdate() {
    fetch("/check_update")
      .then(response => response.json())
      .then(data => {
        if (data.update) {
          fetch("/reset_update_flag")
            .then(() => location.reload())
            .catch(err => console.error("Error resetting update flag:", err));
        }
      });
  }
  setInterval(checkUpdate, 5000); // Check every 5 seconds

  $(document).ready(function () {
    // Initialize DataTable with sorting and scroll options
    const initialSortCol = {{ sort_column|default(2) }};
    const initialSortDir = "{{ sort_direction|default('desc') }}";
    let currentSort = { col: initialSortCol, dir: initialSortDir };

    const $table = $('#documentsTable');
    const dataTable = $table.DataTable({
      scrollY: "calc(100vh - 222px)",
      scrollCollapse: true,
      paging: false,
      info: false,
      scrollX: false,
      order: [[initialSortCol, initialSortDir]],
      columnDefs: [{ orderable: false, targets: 3 }] // Disable sorting on "View" column
    });

    // Apply preserved search term if any
    const preservedSearch = "{{ search_term|default('') }}";
    if (preservedSearch) {
      dataTable.search(preservedSearch).draw();
    }

    // Track currently selected row index (document)
    let selectedIndex = {{ iterator|default(0) }};

    /**
     * Scroll the table body to make the row at given index visible
     * @param {number} index - Row index to scroll to
     */
    function scrollToRow(index) {
      const rowPosition = $table.find('tbody tr').eq(index).position().top;
      $('.dataTables_scrollBody').animate({ scrollTop: rowPosition }, 300);
    }

    /**
     * Update PDF preview iframe, form fields, and highlight selected row
     * @param {number} index - Row index to preview
     */
    function updatePreview(index) {
      const row = $table.find('tbody tr').eq(index);
      const fileName = row.children('td').eq(0).text();

      // Update PDF viewer iframe src
      const pdfUrl = '/static/pdfjs/web/viewer.html?file=/static/pdf/unknown/' + encodeURIComponent(fileName);
      document.getElementById('pdfViewerFrame').src = pdfUrl;

      // Update form fields for editing
      $('#editTitle').val(fileName.replace(/\.[^/.]+$/, "")); // Remove extension
      $('#originalFileName').val(fileName);
      $('#currentIndex').val(index);

      // Highlight selected row
      $table.find('tbody tr').removeClass('row-selected');
      row.addClass('row-selected');

      // Update hidden sort inputs
      $("#sortColumn").val(currentSort.col);
      $("#sortDirection").val(currentSort.dir);

      // Update selected index + scroll doc-row into view 
      selectedIndex = index;
      scrollToRow(index);

      // Set focus into edittitle field
      $('#editTitle').focus();

    }

    // On table sort change, update sort state and selected row index
    dataTable.on('order.dt', function () {
      const order = dataTable.order();
      currentSort.col = order[0][0];
      currentSort.dir = order[0][1];

      $("#sortColumn").val(currentSort.col);
      $("#sortDirection").val(currentSort.dir);

      // Find new index of currently selected document after sort
      const currentFileName = $("#originalFileName").val();
      const indexes = dataTable.rows({ order: 'applied' }).indexes().toArray();

      for (let i = 0; i < indexes.length; i++) {
        if (dataTable.row(indexes[i]).data()[0] === currentFileName) {
          selectedIndex = i;
          $("#currentIndex").val(selectedIndex);
          $table.find('tbody tr').removeClass('row-selected').eq(i).addClass('row-selected');
          break;
        }
      }

      scrollToRow(selectedIndex);
    });

    // Initialize treeview (requires MDB or compatible library)
    $('.treeview').mdbTreeview();

    // Initialize preview on page load: highlight previewed or first item
    const renamedFile = "{{ preview if preview else '' }}";
    if (renamedFile) {
      const indexes = dataTable.rows({ order: 'applied' }).indexes().toArray();
      for (let i = 0; i < indexes.length; i++) {
        if (dataTable.row(indexes[i]).data()[0] === renamedFile) {
          updatePreview(i);
          break;
        }
      }
    } else {
      updatePreview(selectedIndex);
    }

    // Click on table row updates preview
    $table.on('click', 'tbody tr', function () {
      updatePreview($(this).index());
    });

    // Click on eye button also updates preview
    $table.on('click', '.table-view', function () {
      updatePreview($(this).closest('tr').index());
    });

    // Button: preview next document (cycle)
    $('#btnNext').on('click', function (e) {
      e.preventDefault();
      const rowCount = $table.find('tbody tr').length;
      selectedIndex = (selectedIndex + 1) % rowCount;
      updatePreview(selectedIndex);
    });

    // Button: OCR Magic triggers server route with filename
    $('#btnMagic').on('click', function () {
      const fileName = $table.find('tbody tr').eq(selectedIndex).children('td').eq(0).text();
      window.location.href = "/" + encodeURIComponent(fileName);
    });

    // Button: Rotate document by 180 degrees
    $('#btnRotate').on('click', function () {
      const fileName = $table.find('tbody tr').eq(selectedIndex).children('td').eq(0).text();
      window.location.href = "/rotate/" + encodeURIComponent(fileName);
    });

    // Button: Download document opens in new tab
    $('#btnDownload').on('click', function () {
      const fileName = $table.find('tbody tr').eq(selectedIndex).children('td').eq(0).text();
      const url = "/static/pdf/unknown/" + encodeURIComponent(fileName);
      window.open(url, '_blank');
    });

    // Button: Confirm delete triggers server delete route
    $('#btnConfirmDelete').on('click', function () {
      const fileName = $table.find('tbody tr').eq(selectedIndex).children('td').eq(0).text();
      window.location.href = "/delete/" + encodeURIComponent(fileName);
    });

    // Initialize all tooltips
    $('[title], [data-toggle="tooltip"]').tooltip();

    // Save current search term before form submit to preserve it on reload
    $('#pdfPreviewSection form button[type="submit"]').on('click', function () {
      const currentSearch = dataTable.search();
      $('#searchTerm').val(currentSearch);
    });

  });
</script>
{% endblock %}
